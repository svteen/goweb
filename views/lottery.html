<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"/>
    <title>Vp Lottery</title>
    <link rel="stylesheet" href='/static/css/Roboto.css?family=Roboto' type='text/css'>
    <link rel="stylesheet" href="/static/css/screen.css">
</head>
<body>
<div id="wrapper">
    <div id="loader">
        <div class="inner"></div>
    </div>
    <!-- Awards panel -->
    <aside class="zone-container">
        <div class="trigger">
            <i class="icon icon-filter"></i>
        </div>
        <div id="miao">
            <object type="application/x-shockwave-flash" data="/static/flash/miao.swf" width="84" height="90" id="miaoicon" style="visibility:visible;">
                <param name="wmode" value="transparent">
            </object>
        </div>
        <div class="board">
            <div class="first">
                <h1>特等奖</h1>
                <fieldset>
                    <legend></legend>
                </fieldset>
                <div class="list">
                    <p>神秘西藏之旅（可任意选择一条2014全年游侠客西藏专题线路）</p>
                    <ul class="win">
                        <li>
                            <div class="avatar"><img width="34" src="/static/img/blank.gif"/></div>
                            <div class="num">***********</div>
                            <div class="name"></div>
                            <button class="icon icon-delete" title="删除">删除</button>
                        </li>
                    </ul>
                    <code>0/1</code>
                </div>
            </div>
            <div class="second">
                <h1>一等奖</h1>
                <fieldset>
                    <legend></legend>
                </fieldset>
                <div class="list">
                    <p>大美青海之旅（可任意选择一条2014全年游侠客青海湖-敦煌环线线路）</p>
                    <ul class="win">
                        <li class="none">
                            <div class="avatar"><img width="34" src="/static/img/blank.gif"/></div>
                            <div class="num">***********</div>
                            <div class="name"></div>
                            <button class="icon icon-delete" title="删除">删除</button>
                        </li>
                    </ul>
                    <code>0/2</code>
                </div>
            </div>
            <div class="third">
                <h1>二等奖</h1>
                <fieldset>
                    <legend></legend>
                </fieldset>
                <div class="list">
                    <p>坝上草原之旅（可任意选择一条2014全年游侠客坝上草原线路 ）</p>
                    <ul class="win">
                        <li class="none">
                            <div class="avatar"><img width="34" src="/static/img/blank.gif"/></div>
                            <div class="num">***********</div>
                            <div class="name"></div>
                            <button class="icon icon-delete" title="删除">删除</button>
                        </li>
                    </ul>
                    <code>0/3</code>
                </div>
            </div>
            <div class="fourth">
                <h1>三等奖</h1>
                <fieldset>
                    <legend></legend>
                </fieldset>
                <div class="list">
                    <p>坝上草原之旅（可任意选择一条2014全年游侠客坝上草原线路 ）</p>
                    <ul class="win">
                        <li class="none">
                            <div class="avatar"><img width="34" src="/static/img/blank.gif"/></div>
                            <div class="num">***********</div>
                            <div class="name"></div>
                            <button class="icon icon-delete" title="删除">删除</button>
                        </li>
                    </ul>
                    <code>0/5</code>
                </div>
            </div>
            <div class="fifth">
                <h1>四等奖</h1>
                <fieldset>
                    <legend></legend>
                </fieldset>
                <div class="list">
                    <p>坝上草原之旅（可任意选择一条2014全年游侠客坝上草原线路 ）</p>
                    <ul class="win">
                        <li class="none">
                            <div class="avatar"><img width="34" src="/static/img/blank.gif"/></div>
                            <div class="num">***********</div>
                            <div class="name"></div>
                            <button class="icon icon-delete" title="删除">删除</button>
                        </li>
                    </ul>
                    <code>0/6</code>
                </div>
            </div>
            <div class="grateful active">
                <h1>感恩奖</h1>
                <fieldset>
                    <legend></legend>
                </fieldset>
                <div class="list">
                    <p>华东单日游（可任意选择一条2014全年游侠客独家华东单日游线路 ）</p>
                    <ul class="win">
                        <li class="none">
                            <div class="avatar"><img width="34" src="/static/img/blank.gif"/></div>
                            <div class="num">***********</div>
                            <div class="name"></div>
                            <button class="icon icon-delete" title="删除">删除</button>
                        </li>
                    </ul>
                    <code>0/8</code>
                </div>
            </div>
        </div>
    </aside>
    <section id="container" class="clearfix">
        <div class="html5_video">
            <video autoplay loop src="/static/video/cloud.mp4"></video>
        </div>

        <div id="copyleft">
            <div class="favicon">F</div>
            <div class="copyright">ForgetMeNot.com</div>
        </div>

        <section id="content" class="clearfix">
            <div class="flicker">
                <img src="/static/img/winter.jpg" width="150"/>
            </div>
            <div class="counter-container clearfix">
                <div class="counter">
                    <ul class="prefix">
                        <li>*</li>
                        <li>*</li>
                        <li>*</li>
                    </ul>
                </div>
                <div class="counter" style="display: none">
                    <ul class="none">
                        <li>*</li>
                        <li>*</li>
                        <li>*</li>
                        <li>*</li>
                    </ul>
                </div>
                <div class="counter">
                    <ul class="suffix">
                        <li>*</li>
                        <li>*</li>
                        <li>*</li>
                    </ul>
                </div>
            </div>
        </section>
    </section>
</div>
<script type="text/javascript" src="/static/js/jquery-2.0.3.min.js"></script>
<script type="text/javascript" src="/static/js/dataSource.js"></script>
<script type="text/javascript">
//除chrome外，其他支持需要在服务器上运行才支持
if (!window.localStorage) {
    alert('This browser does NOT support localStorage');
}
/*
 * config 奖项设置
 * localStorage 存储设置
 * board面板计奖函数
 */
var config = {
    'awards': 'grateful',
    'keycode': {
        '49': { 'class': 'first', 'name': '特等奖', 'total': 1 },
        '50': { 'class': 'second', 'name': '一等奖', 'total': 2 },
        '51': { 'class': 'third', 'name': '二等奖', 'total': 3 },
        '52': { 'class': 'fourth', 'name': '三等奖', 'total': 5 },
        '53': { 'class': 'fifth', 'name': '四等奖', 'total': 6 },
        '54': { 'class': 'grateful', 'name': '感恩奖', 'total': 8 }
    },
    'special': 'first|second|third',
    'type': 'other',

    get: function (key) {
        return window.localStorage.getItem(key) || ''
    },

    set: function (key, val) {
        window.localStorage.setItem(key, val);
    },

    /*
     *移除选定某项
     *去2个以上','  去前后','
     */
    remove: function (key, val) {
        var key = key || config.awards,
                newval = config.get(key).replace(val, '').replace(/,{2,}/g, ',').replace(/(^,*)|(,*$)/g, '');

        config.set(key, newval);
    },

    //获取当前locals
    getCur: function () {
        return config.get(config.awards)
    },

    //追加并去掉前后','
    setCur: function (val) {
        var oldval = config.getCur(),
                newval = [ oldval, val ].join(',').replace(/(^,*)|(,*$)/g, '');

        config.set(config.awards, newval);
    },

    //查询当前是否有中奖记录！
    query: function (val) {
        for (var key in window.localStorage) {
            //判断随机数是否存在localStorage中
            if ('first|second|third|fourth|fifth|grateful'.indexOf(key) >= 0) {
                if (config.get(key).indexOf(val) >= 0) { //修复有重复中奖的BUG
                    return true
                }
            }
        }
        return false
    },

    //清空设置
    clear: function () {
        window.localStorage.clear()
    },

    //读取本地中奖数据
    reading: function () {
        for (key in config.keycode) {
            var awards = config.keycode[key].class,
                    locals = config.get(awards);

            if (!!locals) {
                var nums = locals.split(','),
                        selector = $('.' + awards);
                for (var i = 0; i < nums.length; i++) {
                    config.appear(selector, nums[i])
                }
            }
        }
    },

    //添加中奖名单
    appear: function (selector, num) {
        var data = dataSource[ num ],
                code = selector.find('code'),
                ratio = code.html(),
                min = ~~/(\d+)\/\d+/.exec(ratio)[1],
                max = ~~/\d+\/(\d+)/.exec(ratio)[1];

        if (min == max) { //全部抽完处理
            var awards = selector.attr('class').split(/\s+/)[0],
                    reg = new RegExp('(\\d+,*){' + max + '}');

            //过滤超过max位
            config.set(awards, reg.exec(config.get(awards))[0].replace(/(^,*)|(,*$)/g, ''))
            return
        }

        var newItem = selector.find('li:eq(0)').clone().removeAttr('class').attr({'data-num': num}).css({'margin-left': 300});

        newItem.find('.num').html(data[ 'tel' ]/*.replace(data[ 'tel' ].substr(3, 4), '****')*/);
        newItem.find('.avatar img').attr('src', '/static/'+data[ 'url' ]);
        newItem.find('.name').html(data[ 'nick' ]);

        if (min > 0) {
            newItem.prependTo(selector.find('.win'));
        } else {
            newItem.replaceAll(selector.find('li:eq(0)'))
        }

        setTimeout(function () {
            newItem.css({'margin-left': 0})
        }, 0)

        code.html(ratio.replace(/^\d+/, min + 1));

        newItem.one('click', 'button', function () {
            var awards = newItem.parent().parent().parent('.active').attr('class').replace('active', '').replace(/^\s*|\s*$/g, '');

            config.remove(awards, newItem.data('num'));
            newItem.css({'transition-delay': 0, 'margin-left': 300});
            code.html(ratio.replace(/^\d+/, ~~/(\d+)\/\d+/.exec(code.html())[1] - 1));

            setTimeout(function () {
                if (newItem.siblings().length == 0) {
                    var none = newItem.clone().addClass('none').removeAttr('style');

                    none.find('.num').html('***********');
                    none.find('.avatar img').attr('src', '/static/img/blank.gif');
                    none.find('.name').html('');

                    none.prependTo(selector.find('.win'))
                }

                newItem.remove()
            }, 600) 
        })
    }
}

config['total'] = dataSource.length;

/*
 * 加载完毕后
 */
function loader() {
    $('#copyleft').fadeOut();
    $('#content, .trigger').addClass('active');

    //空格控制
    var action = $('.counter ul:not(.none) li').filter(function (i) {
                return i >= 0  //filter
            }),
            lock = true,
            boot = Lucky(action);

    $(document).on('keydown.lazyloader', function (e) {

        if (e.keyCode == 32) {//空格
            if (config.getCur().split(',').length) {

            }
            if (lock) {
                lock = boot.aStart();
            } else {
                lock = boot.lottery();
                //console.log( 'grateful length:' + $('.grateful li:not(.none)').length )
                //当删除未领奖的时候，默认启用一次抽一次
                config.awards == 'grateful' && taxis(/*$('.grateful li:not(.none)').length % 2*/);
            }
        }
    })

    function taxis(i) {
        var i = i || 0;

        setTimeout(function () {
            if (++i < 2) {
                boot.aStart();
                boot.lottery();

                taxis(i); //repeat
            }
        }, 2500)
    }

}

function Lucky(args) {
    var args = args,
            timers = [],
            flicker = $('.flicker > img');

    return {
        //顺序运动
        aStart: function () {
            this.avatar();

            $.each(args, function (i, n) {
                var single = $(n);

                if (single.data('bingo') == undefined) {
                    single.data('bingo', Bingo(single));
                }

                timers[ i ] = setTimeout(function () {
                    single.data('bingo').start();
                }, i * 150)
            });

            return !1;
        },

        /*
         *抽奖
         /^13[0-9]{9}$|14[0-9]{9}|15[0-9]{9}$|18[0-9]{9}$/

         (new Date().getTime() * 9301 + 49297) % 233280 /233280.0 * Max

         ~~(Math.random() * max)
         ~~(Math.random() * (min - max + 1) + max)
         ( new Date().getTime() * 7 - 13 ) % totalCount + 1

         ~~(Math.random()*(max-min+1))

         Math.round( Math.random() * 1000 + .5)
         Math.floor(Math.random() * 730) + 1

         //数组排序  [].sort(function () { return 0.5 - Math.random(); })
         */
        lottery: function () {
            for (var x in timers) {
                try {
                    if (timers.length > ~~x + 1) {
                        clearTimeout(timers[ x ])
                    }
                } catch (e) {

                }
            }

            var lucky = this.randit();
            value = [];

            if (config.type === 'phone') {
                for (var i = 0; i < lucky.length; i++) {
                    ( i > 0 && i < 3 || i > 6 ) && value.push(lucky.charAt(i))
                }
            } else {
                for (var i = 0; i < lucky.length; i++) {
                    value.push(lucky.charAt(i))
                }
            }

            $.each(args, function (i, n) {
                var single = $(n),
                    bingo = single.data('bingo');
                bingo.endTo(~~value[ i ], i * 200, !(i+1));
            })

            return !0;
        },

        /*
         * 随机抽取！
         */
        randit: function () {
            var result = Math.round(Math.random() * config.total + .5) - 1;
            tel = dataSource[ result ][ 'tel' ];

            if (config.query(result)) {
                return this.randit();
            }
            //console.log(config.awards+"::"+dataSource[result].group);
            if (dataSource[result].group === 2 && config.special.indexOf(config.awards) >= 0) {
                return this.randit();
            }

            //html5存储序列号
            config.setCur(result);

            setTimeout(function () {
                //停止头像
                clearTimeout(timers[ args.length ]);

                flicker.attr('src', '/static/'+dataSource[ result ][ 'url' ]);

                config.appear($('.' + config.awards), result)
            }, 1000)

            return tel;
        },

        /*
         * 头像变换！
         */
        avatar: function () {
            var result = Math.round(Math.random() * config.total + .5) - 1;

            url = dataSource[ result ][ 'url' ];

            flicker.attr('src', '/static/'+url);

            timers[ args.length ] = setTimeout(arguments.callee, 100)
        }
    }
}

/*
 * 摇奖机Bingo
 * 从下至上循环摇动，控制backgroundPositionY
 * arg $对象
 */
function Bingo(arg) {
    var code = '0123456789', //网络识别号 [ 2 ]{ 3, 4, 5, 8 }
        //RegExp( /^13[0-9]{9}$|14[0-9]{9}|15[0-9]{9}$|18[0-9]{9}$/ )
        loop = 0,      //循环次数
        running = 0,   //0 - 9
        timer = null;  //控制摇动时间

    /*
     * 增加随机步数selfAuto
     * 保证每次跳跃次数不一致
     * 范围 Math.random() * 10   --  [ 0 - 9 ]
     */
    function selfAuto() {
        running += ~~( Math.random() * 10 );
        format();
    }

    /*
     * 格式化format
     * running 保持0-9区间
     */
    function format() {
        if (running >= 10) {
            loop++;
            running -= 10;
        }
    }

    return {
        start: function () {
            selfAuto();

            arg.css({
                'background-position-y': -120 * ( 10 * loop + running )
            })

            //[50, 100]
            timer = setTimeout(arguments.callee, Math.random() * 50 + 50)
        },

        stop: function () {
            clearTimeout(timer)
        },

        endTo: function (num, timer) {
            this.stop();
            timer = timer || 200;

            //网络识别号 [ 2 ]{ 3, 4, 5, 8 }
            if (arguments[2] != undefined && arguments[2]) {
                var to = code.indexOf(num),
                        from = ( 10 * loop + running ) % 4;

                if (to >= from) {
                    running += to - from;
                } else {
                    running += 4 + to - from;
                }
                format();
            } else {
                if (num < running) {
                    loop++;
                }
                running = num;
            }

            arg.animate({
                'background-position-y': -120 * ( 10 * loop + running  )
            }, timer)
        }
    }
}

$(document).ready(function () {
    var per = $('#loader .inner');

    $("#loader").addClass("ready");
    per.css('width', '100%');
    setTimeout(function () {
        per.css('transform', 'scale(1, 1)')
    }, 550);

    setTimeout(function () {
        $("#loader").animate({'opacity': 0}, 'fast', function () {
            $(this).remove()
        });
        $('#copyleft').addClass('active');
    }, 750);

    setTimeout(loader, 2500);

    $('.trigger').on('click', function () {
        if (!$(this).data('active')) {
            $('.zone-container').addClass('active');

            $('#content .counter-container').animate({'margin-left': -60}, 'fast'); //293
            $('#content .flicker').animate({'margin-left': 100}, 'fast');

            $(this).data('active', true);
        } else {
            $('.zone-container').removeClass('active');

            $('#content .counter-container').animate({'margin-left': -223}, 'fast');
            $('#content .flicker').animate({'margin-left': -50}, 'fast');

            $(this).data('active', false);
        }
    });

    config.reading();

    /*
     *更换壁纸、设置全局抽奖奖项
     *键盘操作[1: 一等奖, 2: 二等奖, 3: 三等奖, 4: 感恩奖，0: 全显]
     *CTRL + DEL 重置
     */
    $(document).on('keydown', function (e) {
        var k = config.keycode[ e.keyCode ];

        if (!!k) {
            config.awards = k.class;

            $('.' + config.awards).addClass('active').siblings().removeClass('active')

            //$('.flicker').attr('src', config.prize_image)

        } else if (e.keyCode == 48) {
            config.awards = 'grateful';

            $('.board > div').addClass('active');
        } else if (e.ctrlKey && e.keyCode == 46) {

            config.clear();

            window.location.reload()
        }
        else if (e.keyCode == 90) {
            $('.trigger').trigger('click');
        }
    })
})
</script>
</body>
</html>